# 手术机器人应用 (Surgical Robot App)

一个用于医学图像分割、3D 重建与路径规划的交互式桌面应用程序。支持**多标签分割**（同时分割多个解剖结构）和**多结构 3D 重建**（不同标签用不同颜色显示）。本文档覆盖当前已实现的全部功能。

---

## ✅ 运行环境
- **操作系统**：macOS / Windows / Linux  
- **Python**：3.8+（推荐 3.10+）  
- **可选 GPU**：CUDA 或 Apple MPS  

## 🚀 安装与启动（从零开始）
```bash
git clone <your-repo-url>
cd surgerybot
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r surgical_robot_app/requirements.txt
python -m surgical_robot_app.main
```

## 📦 SAM2（可选）
```bash
pip install git+https://github.com/facebookresearch/sam2.git
```
模型文件放在 `models/sam2/`（该目录已加入 `.gitignore`，不会提交到仓库）。

---

## 🧭 一次完整使用流程（新手版）
1. **进入系统** → 欢迎页点击 **ENTER SYSTEM**  
2. **填写患者信息** → 点击 **CONFIRM && PROCEED**  
3. **导入数据** → **Select Folder** → **Import**  
4. **分割** → 选择标签 → 用 SAM2 或手动分割 → 切换标签分割其他结构  
5. **3D 重建** → **Reconstruct 3D**（自动为每个标签生成不同颜色的模型）  
6. **路径规划** → 选点 → 生成路径 → 评估 → 保存  

---

## 🧩 UI 组件与“逐按钮”用法（非常细致）

### 1) Welcome View（欢迎页）
- **ENTER SYSTEM**：进入患者信息页  

### 2) Patient Info View（患者信息页）
- **Name / Patient ID / Case No / Exam Type**：患者信息  
- **CONFIRM && PROCEED**：确认并进入主界面  
- **Back**：返回欢迎页  
- **Exit**：退出程序  

### 3) 主界面结构
主界面由三部分组成：  
- **左侧控制面板**：数据导入、切片编辑、SAM2 分割  
- **中间 3D 视图面板**：重建/模型显示/路径规划  
- **顶部状态栏**：显示当前患者信息  

---

## 📂 数据导入（Data Import Panel）
### 目标
把 DICOM/PNG 序列加载为体数据，或直接加载 STL 模型。

### 按钮说明
- **Select Folder**  
  - 选择包含 DICOM 或 PNG 的文件夹  
  - 仅选择目录，不选单个文件  
- **Import**  
  - 读取文件夹中的序列  
  - 成功后显示 “Series loaded | format: ... | slices: ...”  
- **Open Local Model**  
  - 直接加载 STL 文件  
  - 适用于只做 3D 查看或 STL 路径规划  

### 文件列表
- 显示序列切片文件名  
- 第一行显示加载状态与切片数量  

---

## 🖌️ 切片编辑器（手动分割）
### 目标
逐层编辑掩码，或通过 HSV 阈值快速分割。

### 控件说明
- **Slice Slider**：切换当前切片  
- **Brush**：画笔前景（生成掩码）  
- **Eraser**：擦除掩码  
- **Threshold**：HSV 阈值区（可折叠）  
- **Apply**：应用阈值到当前切片  
- **Apply to All**：批量应用阈值（异步执行）  
- **Save Masks**：保存所有掩码到文件夹  
- **Clear Masks**：清空掩码  

### 推荐操作
- 先用 HSV 阈值粗分割  
- 再用画笔/擦除微调边界  

---

## 🤖 SAM2 分割面板
### 目标
使用 SAM2 自动分割当前切片或整个体数据。支持**多标签分割**。

### 按钮说明
- **Load SAM2 Model**：加载 `.pt` 权重  
- **Add Positive / Negative**：在图像上点击添加正/负样本点  
- **Add Box**：拖拽矩形框，支持实时预览  
- **Switch Mask**：切换 Whole / Part / Sub‑part 候选  
- **Start Segmentation**：对当前切片分割  
- **SAM2 Volume**：全卷分割（双向追踪）  

### 注意
- 未加载模型无法使用 SAM2  
- 全卷分割需要至少一个提示点  

---

## 🏷️ 多标签分割（Multi-Label Segmentation）
### 目标
同时分割多个解剖结构（如肿瘤、血管、器官等），每个结构独立存储、独立颜色显示、独立 3D 重建。

### 标签选择器（Label Panel）
位于 SAM2 分割面板上方，包含：
- **下拉框**：显示所有标签（带颜色图标），切换当前活跃标签  
- **"+" 按钮**：添加新标签（弹出输入框命名）  
- **"−" 按钮**：删除当前标签及其所有分割数据  

### 预定义颜色
| 标签 ID | 颜色 |
|---------|------|
| 1 | 红色 |
| 2 | 蓝色 |
| 3 | 绿色 |
| 4 | 橙色 |
| 5 | 紫色 |
| 6 | 青色 |
| 7 | 黄色 |
| 8 | 粉色 |

### 多标签工作流程
1. 默认有 **Label 1**（红色）  
2. 用 SAM2 分割第一个结构 → 2D 切片上显示红色半透明覆盖  
3. 点击 **"+"** 添加新标签（如 "肿瘤"） → 自动分配蓝色  
4. 下拉框切换到新标签  
5. 用 SAM2 分割第二个结构 → 2D 切片上显示蓝色半透明覆盖  
6. 两个标签的分割 **互不干扰**  
7. 可随时切换回任意标签进行修改，只影响该标签的区域  

### 数据存储
- 每个切片的 mask 是一个多标签数组（像素值 = 标签 ID，0 = 背景）  
- SAM2 输出的二值 mask 会自动按当前标签 ID 写入  
- `SAM2 Volume` 全卷分割同样只写入当前标签  

---

## 🧱 3D 重建与视图
### 目标
由掩码生成 3D 模型并展示。支持**多标签同时重建**。

### 按钮说明
- **Reconstruct 3D**  
  - 自动检测所有标签，逐标签进行 Marching Cubes 重建  
  - 每个标签生成独立的 3D 模型，使用对应标签颜色  
  - 所有模型同时显示在 3D 视图中  
  - 自动填孔并显示坐标轴  
  - 每个标签的 STL 文件分别保存（如 `model_肿瘤_xxx.stl`）  
- **Open Model**  
  - 加载 STL 文件  
- **Reset Camera**  
  - 重置视角与缩放  
- **Open in Window**  
  - 独立 3D 窗口显示（同步所有标签模型及颜色）  

---

## 🧭 路径规划面板
### 目标
生成从起点到终点（经中间点）的路径，并评估质量。多标签分割的所有结构统一作为障碍物。

### 按钮说明
- **Pick Start / Add Waypoint / Pick End**  
  - 进入选点流程  
  - 有体数据：弹窗三视图（显示**所有标签**的合并障碍投影）  
  - 仅 STL：坐标平面选点  
- **Generate Path**  
  - 使用 RRT 或 A* 生成路径  
  - 规划过程中实时显示 RRT 探索树（灰色半透明线段）  
  - 找到路径时绿色高亮显示，规划完成后探索树自动清除  
- **Replay**  
  - 回放 RRT 探索过程动画（规划完成后自动启用）  
  - 点击后可看到探索树逐步生长的完整过程  
  - 回放中可随时点击 **Stop** 中断  
- **Simulate**  
  - 沿规划路径动画演示器械运动轨迹（规划完成后自动启用）  
  - 一个青色球体代表器械，沿路径从起点平滑移动到终点  
  - 已经过的轨迹用绿色高亮显示，状态栏实时显示进度百分比  
  - 仿真中可随时点击 **Stop** 中断  
- **Show Safety Zone** (复选框)  
  - 在路径周围显示半透明绿色管道，代表安全距离包络  
  - 管道半径由配置的安全半径决定（默认 `safety_radius`）  
  - 可直观判断路径是否与障碍物过近  
  - 勾选启用，取消勾选隐藏  
- **Save Path**  
  - 保存路径点列表  
- **Reset Path**  
  - 清空路径与选点  

### 路径列表
- 显示 Start / Waypoint / End  
- 显示路径评分  
- 显示路径点 `[n]: (x,y,z)`  
- 双击任意点可编辑  

### 多标签与路径规划
- 路径规划时，所有已分割的标签（无论标签 ID）都会被转换为统一的二值障碍体积  
- 选点弹窗中的障碍物投影会合并所有 3D 重建模型的表面数据  

---

## ✏️ 路径点编辑（双击列表）
### 功能
- 在 XY / XZ 平面精确拖拽  
- 实时碰撞检测  
- 支持删除中间点  
- **编辑后自动局部重规划**：移动任意路径点后，受影响的前后两段会自动调用 RRT 局部重规划，保持路径平滑且避障  

### 操作步骤
1. 双击列表点（Start/End/路径点）  
2. 在 XY / XZ 平面拖动  
3. 点击 **Apply** 保存  
4. 系统自动对前后两段进行局部 RRT 重规划  

---

## 🎯 选点机制（非常详细）

### A. 有体数据时（DICOM/PNG）
- 点击 **Pick Start/Waypoint/End** 后弹出 **PathPointPickerDialog**  
- 弹窗显示三视图（轴向/矢状/冠状）  
- **两次点击完成一个 3D 点**：  
  1) 第一次点击确定一个平面坐标  
  2) 第二次在另一个平面补齐第三个坐标  
- 完成后自动换算为 **空间坐标** 并写入路径点列表  

### B. 仅 STL 模型时
- 点击 **Pick Start/Waypoint/End** 后弹出 **CoordinatePlanePickerDialog**  
- **XY 平面**确定 X/Y  
- **XZ 平面**确定 X/Z  
- 提供滑块与数值输入框做细调  
- 3D 视图实时预览点位置  

### C. 坐标系统说明
- **体数据**：路径规划使用物理坐标（mm）  
- **STL 模型**：使用归一化坐标（0-100）  

---

## 🧪 数据格式
- **DICOM**：目录内 `.dcm`  
- **PNG**：连续切片序列  
- **STL**：三角网格模型  

---

## 🧩 关键实现说明（已实现部分）
- **多标签分割**：`DataManager` 使用多标签数组（像素值 = 标签 ID），支持添加/删除/切换标签，每个标签独立管理  
- **多结构 3D 重建**：逐标签提取二值体积 → Marching Cubes → 独立 Actor + 独立颜色，同时显示在视图中  
- **2D 多色覆盖**：切片编辑器使用 `_apply_multilabel_overlay` 方法，为每个标签按其颜色半透明叠加显示  
- **路径规划障碍物合并**：`path_service.py` 将多标签体积转为二值 (`np.where(seg_mask_volume > 0, 255, 0)`) 后传入路径控制器  
- **选点弹窗多模型投影**：`path_ui_controller.py` 收集渲染器中所有 Actor 的 PolyData，合并为单一 PolyData 后传入弹窗  
- **Open in Window 颜色同步**：深拷贝 Actor 时同步 `ScalarVisibility` 和高光属性，确保颜色一致  
- **路径规划坐标**：体数据在有 `Spacing` 时使用物理坐标（mm）；STL 仍使用归一化坐标（0-100）  
- **路径后处理**：生成路径后重采样 + 平滑 + 碰撞复验  
- **路径点编辑**：支持双击编辑 Start/End 与路径点，编辑后自动 RRT 局部重规划（而非直线连接）  
- **RRT 实时可视化**：规划过程中每 100 次迭代通过 Qt 信号将树边数据从后台线程发送到主线程渲染（灰色半透明探索树 + 绿色已找到路径）  
- **RRT 回放**：规划过程中保存快照数据，规划完成后可通过 Replay 按钮以 QTimer 动画回放探索过程  
- **路径执行仿真**：路径生成后可通过 Simulate 按钮启动器械运动动画，青色球体沿路径平滑移动，绿色轨迹实时绘制已通过路段，状态栏显示进度百分比  
- **碰撞安全裕度可视化**：使用 `vtkTubeFilter` 将路径折线膨胀为半透明管道，管道半径 = 安全距离，启用 VTK Depth Peeling 保证透明渲染正确  

---

## ⚙️ 配置（可选）
在项目根目录添加 `config.json`：
```json
{
  "path_planning": {
    "grid_size": [100, 100, 105],
    "obstacle_expansion": 4,
    "use_rrt": true,
    "rrt_step_size": 2.0,
    "rrt_goal_bias": 0.1,
    "rrt_max_iterations": 5000,
    "rrt_goal_threshold": 2.0,
    "rrt_safety_radius": 5.0
  }
}
```

---

## 📁 项目结构
```
surgerybot/
├── surgical_robot_app/          # 主应用代码
│   ├── main.py                  # 应用入口
│   ├── config/                  # 配置管理
│   ├── data_io/                 # 数据输入输出
│   ├── gui/                     # 图形界面
│   ├── segmentation/            # 分割模块
│   ├── path_planning/           # 路径规划
│   ├── 3d_recon/                # 3D 重建
│   ├── vtk_utils/               # VTK 工具
│   └── utils/                   # 通用工具
├── models/                      # 模型文件（忽略）
├── logs/                        # 日志
└── README.md
```

---

## 🧹 仓库忽略内容
以下内容已加入 `.gitignore`：  
- `models/`  
- `surgical_robot_app/test_data/`  
- `path_data/`  
- `surgical_robot_app/3d_recon/result/`  

---

## 🧪 常见问题
**Q: VTK 窗口不显示？**  
A: 确认已安装 `vtk` 并且 Qt 绑定可用。  

**Q: SAM2 模型加载失败？**  
A: 确认已安装 `sam2` 且模型文件在 `models/sam2/`。  

**Q: 路径仍穿过物体？**  
A: 增大安全半径或提升点云密度。  

**Q: 切换标签后分割会覆盖其他标签吗？**  
A: 不会。每次分割只修改当前选中标签的区域，其他标签的 mask 不受影响。  

**Q: 3D 重建只显示一种颜色？**  
A: 确认已使用多标签分割（不同标签 ID），而非全部都在 Label 1 上操作。  

**Q: 选点弹窗中只看到部分障碍物投影？**  
A: 已修复。当前版本会收集渲染器中所有 Actor 的表面数据，合并后投影到选点平面。  

**Q: 编辑路径点后变成直线了？**  
A: 已修复。当前版本编辑路径点后会自动对受影响的前后两段进行 RRT 局部重规划，保持路径平滑。  

**Q: Replay 按钮是灰色的？**  
A: Replay 在路径规划完成后才启用。需要先点击 Generate 生成路径。  

---

## 📌 项目状态

### ✅ 已完成
- 图像分割（手动 + SAM2 自动）  
- **多标签分割**（同时分割多个解剖结构，独立管理）  
- **多结构 3D 重建**（每个标签独立颜色显示）  
- 路径规划（RRT / A*，多标签统一障碍物）  
- **RRT 探索过程实时可视化 + 回放**  
- **路径点编辑后自动局部重规划**  
- **路径执行仿真**（沿规划路径动画演示器械运动轨迹）  
- **碰撞安全裕度可视化**（路径周围半透明安全距离管道）  
- 路径评估与保存  
- UI 工作流（欢迎页 → 患者信息 → 主界面）  

### 🚧 待完成 / 未来改进
- **机器人控制接口**：与实际机器人硬件或仿真器（如 ROS）的通信模块  
- **配准（Registration）**：图像坐标系到患者/机器人物理坐标系的变换（点对点配准、表面配准 ICP 等）  
- **实时导航（Navigation）**：手术中实时跟踪器械位置并叠加到 3D 模型上  
- **单元测试与集成测试**：提升代码覆盖率与稳定性  

## 🧾 许可证
待补充

