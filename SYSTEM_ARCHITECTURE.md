# 系统架构图

## 项目概述

本项目旨在开发一个用于胆囊穿刺手术的AI辅助机器人系统的医疗图像处理和远程控制软件模块。

**核心目标**：
- 医疗图像处理和分割
- 交互式术前规划
- 机器人远程控制
- 视觉引导和跟踪
- 安全协议和故障保护

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        用户界面层 (UI Layer)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ 术前规划界面 │  │ 实时监控界面 │  │ 机器人控制界面│              │
│  │ Pre-op UI    │  │ Monitor UI   │  │ Robot Ctrl UI│              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│         │                  │                  │                      │
│         └──────────────────┼──────────────────┘                      │
│                            │                                          │
└────────────────────────────┼──────────────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────────────┐
│                   应用控制层 (Application Layer)                      │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │              MainWindow (主窗口协调器)                      │     │
│  │  - UI 构建和布局管理                                        │     │
│  │  - 控制器初始化                                              │     │
│  │  - 信号连接                                                  │     │
│  └────────────────────────────────────────────────────────────┘     │
│                            │                                          │
│         ┌──────────────────┼──────────────────┐                      │
│         │                  │                  │                      │
└─────────┼──────────────────┼──────────────────┼──────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      业务逻辑层 (Business Logic Layer)                │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  术前规划模块    │  │  机器人控制模块  │  │  视觉模块        │  │
│  │ Pre-op Planning  │  │ Robot Control   │  │ Vision Module    │  │
│  │                  │  │                  │  │                  │  │
│  │ - 路径规划       │  │ - 机器人通信     │  │ - 目标注册       │  │
│  │ - 3D可视化      │  │ - 命令发送       │  │ - 目标跟踪       │  │
│  │ - 交互式规划     │  │ - 状态监控       │  │ - 坐标转换       │  │
│  │ - 路径优化(RL)  │  │ - 远程控制       │  │ - 标定配准       │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  图像处理模块    │  │  安全模块        │  │  数据管理模块    │  │
│  │ Image Processing │  │ Safety Module    │  │ Data Management  │  │
│  │                  │  │                  │  │                  │  │
│  │ - 图像分割       │  │ - 安全检查       │  │ - 数据加载       │  │
│  │ - 3D重建        │  │ - 紧急停止       │  │ - 数据保存       │  │
│  │ - 图像分析       │  │ - 故障检测       │  │ - 状态管理       │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      算法层 (Algorithm Layer)                        │
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ SAM2分割     │  │ A*路径规划   │  │ RL优化       │              │
│  │ SAM2 Seg     │  │ A* Planning  │  │ RL Optimize  │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ Marching     │  │ 目标跟踪     │  │ 坐标转换     │              │
│  │ Cubes 3D    │  │ Tracking     │  │ Transform    │              │
│  │ Reconstruction│  └──────────────┘  └──────────────┘              │
│  └──────────────┘                                                    │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                             │
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ 图像数据     │  │ 路径数据     │  │ 配置数据     │              │
│  │ Image Data   │  │ Path Data    │  │ Config Data  │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      硬件接口层 (Hardware Interface Layer)           │
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ 机器人硬件   │  │ 视觉传感器   │  │ 网络通信     │              │
│  │ Robot        │  │ Vision      │  │ Network      │              │
│  │ Hardware     │  │ Sensors     │  │ Comm         │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

## 详细模块架构

### 1. 术前规划模块（已实现 ✅）

```
┌─────────────────────────────────────────┐
│      术前规划模块 (Pre-op Planning)     │
├─────────────────────────────────────────┤
│ ✅ 图像加载和处理                        │
│ ✅ 图像分割（SAM2/手动）                 │
│ ✅ 3D 模型重建                          │
│ ✅ 多视图切片显示                        │
│ ✅ A* 路径规划                          │
│ ✅ 路径可视化                            │
│ ✅ 路径数据生成                          │
│                                         │
│ ❌ RL 路径优化（未实现）                 │
│ ❌ 路径评估和验证（未实现）               │
└─────────────────────────────────────────┘
```

### 2. 机器人控制模块（未实现 ❌）

```
┌─────────────────────────────────────────┐
│      机器人控制模块 (Robot Control)     │
├─────────────────────────────────────────┤
│ ❌ 机器人通信接口                        │
│    - 串口/USB/网络通信                   │
│    - 通信协议（ROS/Modbus/自定义）       │
│                                         │
│ ❌ 机器人命令控制                        │
│    - 运动控制                            │
│    - 针头插入控制                        │
│    - 位置控制                            │
│                                         │
│ ❌ 机器人状态监控                        │
│    - 位置反馈                            │
│    - 状态反馈                            │
│    - 错误反馈                            │
│                                         │
│ ❌ 机器人配置                            │
│    - 初始化                              │
│    - 校准                                │
│    - 参数设置                            │
└─────────────────────────────────────────┘
```

### 3. 视觉模块（未实现 ❌）

```
┌─────────────────────────────────────────┐
│      视觉模块 (Vision Module)           │
├─────────────────────────────────────────┤
│ ❌ 目标注册                              │
│    - 器官识别                            │
│    - 目标定位                            │
│    - 坐标注册                            │
│                                         │
│ ❌ 目标跟踪                              │
│    - 实时跟踪                            │
│    - 位置更新                            │
│    - 跟踪算法                            │
│                                         │
│ ❌ 标定和配准                            │
│    - 相机标定                            │
│    - 坐标系统一                          │
│    - 图像-机器人坐标转换                 │
└─────────────────────────────────────────┘
```

### 4. 远程控制模块（未实现 ❌）

```
┌─────────────────────────────────────────┐
│      远程控制模块 (Remote Control)      │
├─────────────────────────────────────────┤
│ ❌ 远程控制服务器                        │
│    - WebSocket/HTTP API                  │
│    - 实时通信                            │
│    - 命令转发                            │
│                                         │
│ ❌ 远程控制客户端                        │
│    - 连接管理                            │
│    - 命令发送                            │
│    - 状态接收                            │
│                                         │
│ ❌ 安全认证                              │
│    - 用户认证                            │
│    - 权限管理                            │
│    - 加密通信                            │
└─────────────────────────────────────────┘
```

### 5. 安全模块（未实现 ❌）

```
┌─────────────────────────────────────────┐
│      安全模块 (Safety Module)           │
├─────────────────────────────────────────┤
│ ❌ 安全检查                              │
│    - 路径安全检查                        │
│    - 操作权限检查                        │
│    - 边界检查                            │
│                                         │
│ ❌ 紧急停止                              │
│    - 紧急停止按钮                        │
│    - 自动停止条件                        │
│    - 停止后恢复                          │
│                                         │
│ ❌ 故障检测                              │
│    - 硬件故障检测                        │
│    - 通信故障检测                        │
│    - 故障恢复                            │
└─────────────────────────────────────────┘
```

### 6. 强化学习模块（未实现 ❌）

```
┌─────────────────────────────────────────┐
│   强化学习模块 (Reinforcement Learning) │
├─────────────────────────────────────────┤
│ ❌ RL 环境                               │
│    - 状态空间定义                        │
│    - 动作空间定义                        │
│    - 奖励函数设计                        │
│                                         │
│ ❌ RL 智能体                             │
│    - 策略网络                            │
│    - 价值网络                            │
│    - 训练算法                            │
│                                         │
│ ❌ 路径优化                              │
│    - 路径评估                            │
│    - 路径优化                            │
│    - 决策制定                            │
└─────────────────────────────────────────┘
```

## 数据流图

### 术前规划流程（已实现 ✅）

```
图像数据 → 图像加载 → 图像分割 → 3D重建 → 路径规划 → 路径数据
   ✅          ✅         ✅        ✅         ✅        ✅
```

### 机器人执行流程（未实现 ❌）

```
路径数据 → 机器人控制 → 视觉跟踪 → 实时调整 → 执行完成
   ✅         ❌          ❌         ❌         ❌
```

### 远程控制流程（未实现 ❌）

```
用户命令 → 远程服务器 → 安全检查 → 机器人执行 → 状态反馈
   ❌         ❌          ❌         ❌          ❌
```

## 接口定义建议

### 1. 机器人控制接口

```python
# surgical_robot_app/robot_control/robot_interface.py

class RobotInterface:
    """机器人控制接口"""
    
    def connect(self) -> bool:
        """连接机器人"""
        pass
    
    def disconnect(self) -> bool:
        """断开连接"""
        pass
    
    def send_command(self, command: dict) -> bool:
        """发送命令"""
        pass
    
    def get_status(self) -> dict:
        """获取机器人状态"""
        pass
    
    def move_to_position(self, x: float, y: float, z: float) -> bool:
        """移动到指定位置"""
        pass
    
    def execute_path(self, path_points: List[Tuple[float, float, float]]) -> bool:
        """执行路径"""
        pass
```

### 2. 视觉模块接口

```python
# surgical_robot_app/vision/vision_interface.py

class VisionInterface:
    """视觉模块接口"""
    
    def register_target(self, image: np.ndarray) -> dict:
        """注册目标"""
        pass
    
    def track_target(self, image: np.ndarray) -> dict:
        """跟踪目标"""
        pass
    
    def transform_coordinates(self, image_coord: Tuple, target_space: str) -> Tuple:
        """坐标转换"""
        pass
    
    def calibrate(self, calibration_data: dict) -> bool:
        """标定"""
        pass
```

### 3. 远程控制接口

```python
# surgical_robot_app/remote_control/server.py

class RemoteControlServer:
    """远程控制服务器"""
    
    def start_server(self, host: str, port: int) -> bool:
        """启动服务器"""
        pass
    
    def handle_command(self, command: dict) -> dict:
        """处理命令"""
        pass
    
    def broadcast_status(self, status: dict) -> bool:
        """广播状态"""
        pass
```

## 实现优先级

### Phase 1: 核心功能（高优先级）

1. **机器人控制模块**
   - 定义通信协议
   - 实现基础控制接口
   - 集成机器人驱动

2. **视觉模块**
   - 实现目标注册
   - 实现基础跟踪
   - 实现坐标转换

3. **远程控制基础**
   - 实现本地控制接口
   - 实现状态监控

### Phase 2: 增强功能（中优先级）

4. **安全模块**
   - 实现安全检查
   - 实现紧急停止
   - 实现故障检测

5. **远程控制完整实现**
   - 实现网络通信
   - 实现安全认证

### Phase 3: 优化功能（低优先级）

6. **强化学习**
   - 设计 RL 环境
   - 实现 RL 智能体
   - 训练和优化

7. **高级功能**
   - 路径优化
   - 决策支持
   - 高级安全协议
